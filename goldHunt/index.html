<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ‰å°‹å¯¶å¥ªé‡‘ï¼šæ¢éšªå°éŠæˆ²</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background: #f4f4f4;
    }
    .log {
      white-space: pre-line;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      height: 300px;
      overflow-y: auto;
      transition: all 0.3s ease-in-out;
    }
    button {
      margin: 10px 5px 5px 0;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .player-stats {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .animation {
      animation: flash 0.6s ease-in-out;
    }
    #nextBtn,
    #leaveBtn,
    #restartBtn,
    #historyPanel,
    #closeHistoryBtn {
      display: none;
    }
    #rulesPanel {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    #historyPanel {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .highlight {
      color: red;
      font-weight: bold;
    }
    @keyframes flash {
      0% {
        background-color: #ffeeba;
      }
      100% {
        background-color: #fff;
      }
    }
    /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
    @media (max-width: 600px) {
      body {
        padding: 6px;
        font-size: 18px;
        max-width: 100vw;
      }
      h1 {
        font-size: 22px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      #myTotalGoldPanel {
        font-size: 20px;
        margin-bottom: 12px;
      }
      #players .player-stats {
        font-size: 18px;
        margin-bottom: 16px;
        padding: 8px;
      }
      button {
        width: 100%;
        font-size: 20px;
        margin: 8px 0;
        padding: 16px;
      }
      #rulesPanel, #historyPanel {
        font-size: 18px;
        padding: 12px;
        max-height: 60vh;
      }
      .log {
        font-size: 14px;
        height: 160px;
        padding: 6px;
      }
      a[style*="position:absolute"] {
        position: static !important;
        display: block;
        margin-bottom: 8px;
        font-size: 20px !important;
        width: 100%;
        box-sizing: border-box;
        text-align: center;
      }
    }
    #rulesIconBtn, #historyIconBtn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 4px;
      vertical-align: middle;
    }

    @media (max-width: 600px) {
  #players {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    border-top: 2px solid #ccc;
    z-index: 99;
    padding: 6px 2px 6px 2px;
    max-height: 38vh;
    overflow-y: auto;
    width: 100vw;
    box-sizing: border-box;
  }
  body {
    padding-bottom: 40vh; /* é ç•™åº•éƒ¨ç©ºé–“é¿å…è¢«é®ä½ */
  }
}
@media (max-width: 600px) {
  #menuWrapper {
    position: absolute;
    right: 10px;
    top: 10px;
  }
  #menuDropdown {
    min-width: 140px;
  }
}
  @media (max-width: 600px) {
    /* ...existing code... */
    .log {
      font-size: 20px;
      height: 300px; /* åŸæœ¬160+200=360 */
      padding: 6px;
    }
    /* ...existing code... */
  }
  </style>
</head>
<body>
              <a href="../index.html" style="position:absolute;left:10px;top:10px;font-size:24px;text-decoration:none;background:#eee;padding:6px 18px;border-radius:8px;color:#222;box-shadow:0 2px 6px #ccc;">â† è¿”å›é¸å–®</a>

 <h1 style="display: flex; align-items: center; justify-content: space-between;">

  <span>ğŸ” å°‹å¯¶å¥ªé‡‘ï¼šæ¢éšªå°éŠæˆ²
    
  </span>
      <span>
  <span id="menuWrapper" style="position:relative;">
  <button id="menuBtn" style="font-size:24px;padding:4px 10px;">â˜°</button>
  <span id="menuDropdown" style="display:none;position:absolute;right:0;top:40px;z-index:1000;background:#fff;border-radius:8px;box-shadow:0 2px 8px #aaa;padding:8px 0;">
    <button id="rulesIconBtn" title="éŠæˆ²è¦å‰‡" style="font-size:20px;padding:4px 16px;width:100%;" onclick="toggleRules()">ğŸ“œ </button>
    <button id="historyIconBtn" title="éŠç©æ­·å²" style="font-size:20px;padding:4px 16px;width:100%;" onclick="showHistory()">ğŸ“š </button>
  </span>
</span>
  
  
</span>
</h1>
<div id="myTotalGoldPanel" style="font-size:18px;margin-bottom:10px;color:rgb(5, 1, 255);">
  ğŸ… ä½ å¸¶èµ°ç´¯ç©çš„é‡‘å¡Šï¼š<span id="myTotalGold">0</span>
</div>
  <div id="players"></div>
  <button id="startBtn" onclick="startGame()">ğŸ® éŠæˆ²é–‹å§‹</button>
  <button id="nextBtn" onclick="manualNextEvent()">â­ï¸ ä¸‹ä¸€æ­¥ï¼ˆå€’æ•¸ä¸­ï¼‰</button>
  <button id="leaveBtn" onclick="playerLeave()">ğŸšª é›¢é–‹æ¢éšª</button>
  <button id="restartBtn" onclick="restartGame()">ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²</button>
  <div id="rulesPanel">
    <h3>éŠæˆ²è¦å‰‡èªªæ˜</h3>
    <ul>
      <li>éŠæˆ²æœ€å¤š 50 å›åˆï¼Œæ¯å›åˆè§¸ç™¼éš¨æ©Ÿäº‹ä»¶ã€‚</li>
      <li>ç©å®¶æœ‰ä¸‰ç¨®å„é‹ï¼ˆé™·é˜±ã€æ®­å±ã€æ¯’èŸ²ï¼‰ï¼Œæ¯ç¨®ç´¯ç© 2 æ¬¡æ­»äº¡ã€‚</li>
      <li>å¥½é‹åˆ†å…©ç¨®ï¼šæŠµæ“‹å„é‹ (defense) èˆ‡ é‡‘å¡ŠåŠ å€ (bonus)ã€‚</li>
      <li>é‡åˆ°å¥½é‹æ™‚ï¼Œå…¨é«”ç©å®¶éš¨æ©Ÿç²å¾—ä¸€ç¨®å¥½é‹é»æ•¸ã€‚</li>
      <li>ç™¼ç¾é‡‘å¡Šæ™‚ï¼Œæ¯åæ´»èºç©å®¶å¹³åˆ†ï¼Œä¸¦ç”¨å¥½é‹ bonus å¯åŠ å€æ‰€å¾—é‡‘å¡Šã€‚</li>
      <li>ç©å®¶å¯éš¨æ™‚é¸æ“‡ã€Œé›¢é–‹æ¢éšªã€ï¼Œæ‹¿èµ°ä¿ç•™çš„é‡‘å¡Šï¼Œé›¢é–‹å¾Œç”± AI æ§åˆ¶ï¼Œæ¯å›åˆè‡ªå‹•ç²å¾— 1 é‡‘å¡Šã€‚</li>
      <li>é›¢é–‹ç©å®¶æœ‰æ©Ÿç‡åœ¨éš¨æ©Ÿäº‹ä»¶ä¸­å›æ­¸æ¢éšªã€‚</li>
      <li>æ‰€æœ‰ç©å®¶æ­»äº¡æˆ– 50 å›åˆçµæŸéŠæˆ²ã€‚</li>
    </ul>
  </div>

  <div class="log" id="log"></div>

  <div id="historyPanel"></div>

  <script>

    const menuBtn = document.getElementById("menuBtn");
const menuDropdown = document.getElementById("menuDropdown");

menuBtn.onclick = function() {
  if (menuDropdown.style.display === "none" || menuDropdown.style.display === "") {
    menuDropdown.style.display = "block";
  } else {
    menuDropdown.style.display = "none";
  }
};

// é»æ“Šå¤–éƒ¨è‡ªå‹•é—œé–‰é¸å–®
document.addEventListener("click", function(e) {
  if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
    menuDropdown.style.display = "none";
  }
});

    const historyIconBtn = document.getElementById("historyIconBtn");
    const MAX_TURNS = 50;
    let turn = 0;
    let countdown = 60;
    let countdownTimer;
    let goldReserve = 0;
    let gameOver = false;
    let playCount = 0;

    const players = [
      {
        name: "ç©å®¶Aï¼ˆä½ ï¼‰",
        gold: 0,
        luck: { defense: 0, bonus: 0 },
        bad: { trap: 0, zombie: 0, poison: 0 },
        alive: true,
        left: false,
        isAI: false,
      },
      {
        name: "ç©å®¶B",
        gold: 0,
        luck: { defense: 0, bonus: 0 },
        bad: { trap: 0, zombie: 0, poison: 0 },
        alive: true,
        left: false,
        isAI: true,
      },
      {
        name: "ç©å®¶C",
        gold: 0,
        luck: { defense: 0, bonus: 0 },
        bad: { trap: 0, zombie: 0, poison: 0 },
        alive: true,
        left: false,
        isAI: true,
      },
      {
        name: "ç©å®¶D",
        gold: 0,
        luck: { defense: 0, bonus: 0 },
        bad: { trap: 0, zombie: 0, poison: 0 },
        alive: true,
        left: false,
        isAI: true,
      },
      {
        name: "ç©å®¶E",
        gold: 0,
        luck: { defense: 0, bonus: 0 },
        bad: { trap: 0, zombie: 0, poison: 0 },
        alive: true,
        left: false,
        isAI: true,
      },
    ];

    const logEl = document.getElementById("log");
    const playersEl = document.getElementById("players");
    const startBtn = document.getElementById("startBtn");
    const nextBtn = document.getElementById("nextBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const restartBtn = document.getElementById("restartBtn");
    const rulesPanel = document.getElementById("rulesPanel");
    const historyPanel = document.getElementById("historyPanel");
    const showHistoryBtn = document.getElementById("showHistoryBtn");
    const closeHistoryBtn = document.getElementById("closeHistoryBtn");


    // å°‡åŸæœ¬ç”Ÿæˆæ¯ä½ç©å®¶ HTML çš„é‚è¼¯å°è£æˆå‡½å¼
function generatePlayerHtml(p, maxGold) {
  const badSum = Object.values(p.bad).reduce((a, b) => a + b, 0);
  const badHtml = Object.entries(p.bad)
    .map(([key, val]) => {
      const nameMap = { trap: "é™·é˜±", zombie: "æ®­å±", poison: "æ¯’èŸ²" };
      const colorClass = val > 0 ? "highlight" : "";
      return `<span class="${colorClass}">${nameMap[key]}:${val}</span>`;
    })
    .join("ã€");

  const goldClass = p.gold === maxGold && maxGold > 0 ? "highlight" : "";

  let statusIcon = "";
  if (!p.alive) statusIcon = "ğŸ’€ æ­»äº¡";
  else if (p.left) statusIcon = "ğŸšª å·²é›¢é–‹";
  else statusIcon = "ğŸ§­ æ¢éšªä¸­";

  return `<div class="player-stats">
    <strong>${p.name}</strong><br>
    ğŸ¥‡ï¼š<span class="${goldClass}">${p.gold}</span><br>
    ğŸ‘¿ï¼š${badSum}ï¼ˆ${badHtml}ï¼‰<br>
    ğŸ€ å¥½é‹æŠµæ“‹ï¼š${p.luck.defense}ã€âœ¨ å¥½é‹åŠ å€ï¼š${p.luck.bonus}
    <div style="margin-top:6px;font-size:18px;text-align:right;">${statusIcon}</div>
  </div>`;
}


    // åªé¡¯ç¤ºç¬¬ä¸€ä½ç©å®¶ï¼Œå…¶é¤˜éš±è—ï¼Œé»æ“ŠæŒ‰éˆ•å±•é–‹å…¨éƒ¨
const maxGold = Math.max(...players.map(p => p.gold)); // âœ… å…ˆè¨ˆç®— maxGold

const firstPlayerHtml = generatePlayerHtml(players[0], maxGold);

const restPlayersHtml = players
  .slice(1)
  .map((p) => generatePlayerHtml(p, maxGold)) // âœ… å‚³å…¥ maxGold
  .join("");


 function updateUI() {
  const maxGold = Math.max(...players.map(p => p.gold));

      if (!players[0].alive) {
      //ç©å®¶Aï¼ˆä½ ï¼‰å·²æ­»äº¡ éš±è—é›¢é–‹æ¢éšªæŒ‰éˆ•
      leaveBtn.style.display = "none";
    }

  // æ‰‹æ©Ÿç‰ˆæ©«å‘ç°¡åŒ–é¡¯ç¤º
  if (window.innerWidth <= 600) {
    playersEl.innerHTML = players
      .map((p) => {
        // ç‹€æ…‹åœ–ç¤º
        let statusIcon = "";
        if (!p.alive) statusIcon = "ğŸ’€";
        else if (p.left) statusIcon = "ğŸšª";
        else statusIcon = "ğŸ§­";
        // é‡‘å¡Šæœ€å¤šè€…åŠ  highlight
        const goldClass = p.gold === maxGold && maxGold > 0 ? "highlight" : "";
         // å„é‹ç¸½æ¬¡æ•¸
      const badSum = Object.values(p.bad).reduce((a, b) => a + b, 0);
       // å„é‹è©³ç´°å…§å®¹
      const badDetail = `é™·é˜±:${p.bad.trap} æ®­å±:${p.bad.zombie} æ¯’èŸ²:${p.bad.poison}`;
      return `<div style="display:inline-block;text-align:center;margin:0 6px;">
        <div style="font-size:22px;">${statusIcon}</div>
        <div style="font-size:15px;">${p.name.replace('ç©å®¶','')}</div>
        <div style="font-size:16px;">ğŸ¥‡<span class="${goldClass}">${p.gold}</span></div>
        <div style="font-size:15px;">
          <span 
            style="cursor:pointer;text-decoration:underline dotted;" 
            onclick="alert('é™·é˜±ï¼š${p.bad.trap}\\næ®­å±ï¼š${p.bad.zombie}\\næ¯’èŸ²ï¼š${p.bad.poison}\\næŠµæ“‹: ${p.luck.defense}\\nåŠ å€ï¼š${p.luck.bonus}')"
            title="é»æ“ŠæŸ¥çœ‹è©³ç´°å„é‹"
          >ğŸ‘¿${badSum}</span>
        </div>
      </div>`;
    })
    .join("");
  } else {
    // æ¡Œé¢ç‰ˆç¶­æŒåŸæœ¬è©³ç´°è³‡è¨Š
 const maxGold = Math.max(...players.map(p => p.gold));

  const firstPlayerHtml = generatePlayerHtml(players[0], maxGold);

  // å…¶ä»–äººï¼ˆç°¡ç•¥é¡¯ç¤ºï¼‰
  const miniPlayersHtml = players.slice(1).map(p => {
    let statusIcon = "";
    if (!p.alive) statusIcon = "ğŸ’€";
    else if (p.left) statusIcon = "ğŸšª";
    else statusIcon = "ğŸ§­";
    const goldClass = p.gold === maxGold && maxGold > 0 ? "highlight" : "";
    const badSum = Object.values(p.bad).reduce((a, b) => a + b, 0);
    return `<div style="display:inline-block;text-align:center;margin:0 6px;">
      <div style="font-size:20px;">${statusIcon}</div>
      <div style="font-size:14px;">${p.name}</div>
      <div style="font-size:15px;">ğŸ¥‡<span class="${goldClass}">${p.gold}</span></div>
      <div style="font-size:14px;">ğŸ‘¿${badSum}</div>
    </div>`;
  }).join("");

  // å…¶ä»–äººï¼ˆè©³ç´°è³‡è¨Šï¼‰
  const restPlayersHtml = players.slice(1).map(p => generatePlayerHtml(p, maxGold)).join("");

  playersEl.innerHTML = `
    ${firstPlayerHtml}
    <div id="miniPlayers">${miniPlayersHtml}</div>
    <div id="morePlayers" style="display:none;">
      ${restPlayersHtml}
    </div>
    ${players.length > 1 ? '<button id="toggleBtn">æŸ¥çœ‹å…¶ä»–äºº</button>' : ''}
  `;

  // æŒ‰éˆ•é‚è¼¯ï¼šåˆ‡æ›è©³ç´°èˆ‡ç°¡ç•¥
  const btn = document.getElementById("toggleBtn");
  const morePlayersDiv = document.getElementById("morePlayers");
  const miniPlayersDiv = document.getElementById("miniPlayers");
  let expanded = false;

  if (btn) {
    btn.addEventListener("click", () => {
      expanded = !expanded;
      if (expanded) {
        miniPlayersDiv.style.display = "none";
        morePlayersDiv.style.display = "block";
        btn.textContent = "æ”¶èµ·å…¶ä»–äºº";
      } else {
        miniPlayersDiv.style.display = "block";
        morePlayersDiv.style.display = "none";
        btn.textContent = "æŸ¥çœ‹å…¶ä»–äºº";
      }
    });
  }
  }
  updateMyTotalGold();
}



    function log(msg) {
      const line = document.createElement("div");
      line.textContent = msg;
      line.className = "animation";
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function getActivePlayers() {
      return players.filter((p) => p.alive && !p.left);
    }
    function getLeftPlayers() {
      return players.filter((p) => p.left && p.alive);
    }

    function goldEvent(baseAmount) {
      const active = getActivePlayers();
      if (active.length === 0) return;
      const bonus = Math.floor(turn / 5);
      const amount = baseAmount + Math.floor(Math.random() * 6) + bonus;

      const eachBase = Math.floor(amount / active.length);
      const leftover = amount % active.length;
      goldReserve += leftover;

      active.forEach((p) => {
        let gain = eachBase;
        if (p.luck.bonus >= 1) {
          gain *= 2;
          p.luck.bonus--;
          log(`âœ¨ ${p.name} ä½¿ç”¨å¥½é‹é‡‘å¡ŠåŠ å€ï¼`);
        }
        p.gold += gain;
      });
      log(
        `ğŸ’° ç™¼ç¾é‡‘å¡Š ${amount}ï¼${active.length} åç©å®¶å¹³åˆ† ${eachBase}ï¼Œå¤šå‡º ${leftover} é€²å…¥ä¿ç•™å€ (${goldReserve})`
      );
      updateUI();
    }

    function luckEvent() {
      const active = getActivePlayers();
      if (active.length === 0) return;
      active.forEach((p) => {
        if (Math.random() < 0.5) {
          p.luck.defense++;
          log(`ğŸ€ ${p.name} ç²å¾—å¥½é‹ï¼ˆæŠµæ“‹å„é‹ +1ï¼‰`);
        } else {
          p.luck.bonus++;
          log(`ğŸ€ ${p.name} ç²å¾—å¥½é‹ï¼ˆé‡‘å¡ŠåŠ å€ +1ï¼‰`);
        }
      });
      updateUI();
    }

   function misfortuneEvent(type, name) {
  const active = getActivePlayers();
  if (active.length === 0) return;
  log(`â˜ ï¸ é­é‡å„é‹ï¼šã€Œ${name}ã€ï¼Œæ‰€æœ‰ç©å®¶ ${type} +1ï¼ˆå¥½é‹æŠµæ“‹å¯æŠµéŠ·ï¼‰`);
  active.forEach((p) => {
    if (p.luck.defense > 0) {
      p.luck.defense--;
      log(`ğŸ›¡ï¸ ${p.name} ä½¿ç”¨å¥½é‹æŠµæ“‹å„é‹ï¼`);
    } else {
      p.bad[type]++;
      log(`âš ï¸ ${p.name} ç´¯ç© ${name}ï¼š${p.bad[type]}/2`);
      // AI å¼·åŒ–ï¼šå„é‹è¶…é2æ™‚è€ƒæ…®é›¢é–‹
      if (p.isAI && p.bad[type] > 2 && p.alive && !p.left) {
        // ä¾æ“šå›åˆèˆ‡é‡‘å¡Šå·®è·æ±ºå®šé›¢é–‹æ„é¡˜
        const maxGold = Math.max(...players.map(pl => pl.gold));
        const goldGap = maxGold - p.gold;
        let leaveChance = 0.5; // åŸºæœ¬é›¢é–‹æ©Ÿç‡
        if (turn > 20) leaveChance += 0.3; // å›åˆæ•¸é«˜æ™‚æé«˜é›¢é–‹æ„é¡˜
        if (goldGap > 10) leaveChance += 0.2; // è½å¾Œå¤ªå¤šä¹Ÿæƒ³é›¢é–‹
          if (goldReserve > 10) leaveChance += 0.2; // ä¿ç•™é‡‘å¡Šå¤šæ™‚å†æé«˜
  if (rank <= 3) leaveChance += 0.2;
 
        if (Math.random() < leaveChance) {
          p.left = true;
          p.gold += goldReserve;
          goldReserve = 0;
          log(`ğŸ¤– ${p.name} å› å„é‹éå¤šæ±ºå®šé›¢é–‹æ¢éšªï¼Œå¸¶èµ°é‡‘å¡Šèˆ‡ä¿ç•™é‡‘ï¼`);
        }
      }
      if (Object.values(p.bad).filter((b) => b >= 2).length >= 1) {
        p.alive = false;
        p.gold = 0; // æ­»äº¡æ™‚é‡‘å¡Šæ­¸é›¶
        log(`ğŸ’€ ${p.name} å›  ${name} æ­»äº¡ï¼`);
      }
    }
  });
  updateUI();
}

    function exitChoiceEvent() {
      const active = getActivePlayers();
      if (active.length === 0) return;

      log("â³ é€²å…¥æ±ºç­–éšæ®µï¼ˆ60ç§’å…§ï¼‰ï¼Œå¯é¸æ“‡é›¢é–‹æˆ–ç¹¼çºŒæ¢éšª...");
      startLeaveCountdown();

      leaveBtn.style.display = "inline-block";
    }

    function playerLeave() {
      const player = players[0]; // ç©å®¶Aï¼ˆä½ ï¼‰
      if (!player.left && player.alive && !gameOver) {
        player.left = true;
        player.gold += goldReserve;
        goldReserve = 0;
        log(`ğŸšª ${player.name} é¸æ“‡é›¢é–‹æ¢éšªï¼Œå¸¶èµ°é‡‘å¡Šèˆ‡ä¿ç•™é‡‘ï¼`);
        updateUI();

        leaveBtn.style.display = "none";
      }
    }

   function leftPlayerRandomEvent() {
    
  const leftPlayers = getLeftPlayers();
  leftPlayers.forEach((p, idx) => {
    // ç©å®¶Aï¼ˆä½ ï¼‰æ‰é¡¯ç¤ºå›æ­¸æŒ‰éˆ•ï¼ŒAIè‡ªå‹•åˆ¤æ–·
    if (!gameOver && !p.isAI) {
      let countdown = 30;
      leaveBtn.style.display = "inline-block";
      leaveBtn.textContent = `ğŸ”„ å›æ­¸æ¢éšªï¼ˆ${countdown}sï¼‰`;
      leaveBtn.disabled = false;

      const interval = setInterval(() => {
        countdown--;
        leaveBtn.textContent = `ğŸ”„ å›æ­¸æ¢éšªï¼ˆ${countdown}sï¼‰`;
        if (countdown <= 0) {
          clearInterval(interval);
          leaveBtn.style.display = "none";
          log(`â° ${p.name} è¶…é10ç§’æœªé¸æ“‡ï¼Œæ”¾æ£„æœ¬æ¬¡å›æ­¸æ©Ÿæœƒï¼`);
        }
      }, 1000);

      leaveBtn.onclick = function () {
        clearInterval(interval);
        p.left = false;
        leaveBtn.style.display = "none";
        log(`ğŸ”„ ${p.name} é¸æ“‡å›æ­¸æ¢éšªï¼`);
        leaveBtn.disabled = false;
        leaveBtn.textContent = `ğŸšª é›¢é–‹æ¢éšª`;
        updateUI();
      };
    } else if (!gameOver && p.isAI) {
      // AI 30%æ©Ÿç‡å›æ­¸
      // è¨ˆç®—ç›®å‰æ’å
      const sorted = [...players].sort((a, b) => b.gold - a.gold);
      const rank = sorted.findIndex(pl => pl === p) + 1;
      let comebackChance = 0.3;
      if (rank <= 3) comebackChance += 0.4; // å‰3åå†+20%
      if (Math.random() < comebackChance) {
        p.left = false;
        log(`ğŸ”„ ${p.name} é›¢é–‹å¾Œæ±ºå®šå›æ­¸æ¢éšªï¼ï¼ˆæ’åï¼š${rank}ï¼‰`);
      } else {
        p.gold += 1;
        log(`ğŸ’° ${p.name} é›¢é–‹ä¸­ç²å¾— 1 é‡‘å¡Šï¼ˆè‡ªå‹•ç´¯ç©ï¼‰`);
      }
    }
  });
  updateUI();
}
   function saveGameHistory() {
  playCount++;
  let history = JSON.parse(localStorage.getItem("treasureHuntHistory") || "[]");
  // æ–°å¢ï¼šè¨˜éŒ„ç©å®¶ç‹€æ…‹
  const record = {
    id: playCount,
    timestamp: new Date().toLocaleString(),
        turns: turn, // æ–°å¢ï¼šæœ¬å±€å›åˆæ•¸
    players: players.map((p) => {
      let status = "";
      if (!p.alive) {
        status = "æ­»äº¡";
      } else if (p.left) {
        status = "é›¢é–‹";
      } else {
        status = "å®ŒæˆéŠæˆ²";
      }
      return { name: p.name, gold: p.gold, status };
    }),
  };
  history.push(record);
  localStorage.setItem("treasureHuntHistory", JSON.stringify(history));
  localStorage.setItem("treasureHuntPlayCount", playCount.toString());

    // æ–°å¢ï¼šç´¯ç©è‡ªå·±ï¼ˆé‡‘å¡Šï¼‰ç¸½æ•¸
  const self = players[0];
  let totalGold = Number(localStorage.getItem("myTotalGold") || "0");
  totalGold += self.gold;
  localStorage.setItem("myTotalGold", totalGold.toString());
}

function showHistory() {
  let history = JSON.parse(localStorage.getItem("treasureHuntHistory") || "[]");
  if (history.length === 0) {
    alert("ç›®å‰ç„¡éŠç©æ­·å²");
    return;
  }
  let html = "";
  history.forEach((record) => {
    let maxGold = Math.max(...record.players.map((p) => p.gold));
    const playersHtml = record.players
      .map((p) => {
        const highlightClass = p.gold === maxGold ? "highlight" : "";
        // é¡¯ç¤ºç‹€æ…‹
        return `<div class="${highlightClass}">${p.name}ï¼š${p.gold} é‡‘å¡Šï¼ˆ${p.status}ï¼‰</div>`;
      })
      .join("");
    html += `<div><strong>éŠæˆ² #${record.id} (${record.timestamp})ã€€å›åˆæ•¸ï¼š${record.turns || "-"} </strong><br/>${playersHtml}</div><hr/>`;
  });
  historyPanel.innerHTML = html;
  historyPanel.style.display = "block";
  historyIconBtn.textContent = "âŒ";
  historyIconBtn.onclick = closeHistory;
  updateMyTotalGold();
}

function closeHistory() {
  historyPanel.style.display = "none";
  historyIconBtn.textContent = "ğŸ“š";
  historyIconBtn.onclick = showHistory;
}

    function checkGameOver() {
        
      const active = getActivePlayers();
      if (active.length === 0) {
        gameOver = true;
        log("\nâš ï¸ æ‰€æœ‰ç©å®¶çš†æ­»äº¡ï¼ŒéŠæˆ²çµæŸï¼");
         showWinner();
        saveGameHistory();
        showRestartBtn();
        return true;
      }
      if (turn >= MAX_TURNS) {
        gameOver = true;
        log("\nğŸ‰ éŠæˆ²çµæŸï¼æ‰€æœ‰å›åˆå®Œæˆï¼");
         showWinner();
        saveGameHistory();
        showRestartBtn();
        return true;
      }
      return false;
    }

    // æ–°å¢ä¸€å€‹å‡½å¼ä¾†é¡¯ç¤ºé‡‘å¡Šæœ€å¤šçš„ç©å®¶
function showWinner() {
  const maxGold = Math.max(...players.map(p => p.gold));
  const winners = players.filter(p => p.gold === maxGold);
  if (winners.length === 1) {
    log(`ğŸ† æ­å–œ ${winners[0].name} ç²å¾—æœ€å¤šé‡‘å¡Š (${maxGold})ï¼`);
  } else {
    const names = winners.map(p => p.name).join("ã€");
    log(`ğŸ† æ­å–œ ${names} ä¸¦åˆ—æœ€å¤šé‡‘å¡Š (${maxGold})ï¼`);
  }
}

    function showRestartBtn() {
      nextBtn.style.display = "none";
      leaveBtn.style.display = "none";
      restartBtn.style.display = "inline-block";
    }

    function startGame() {
  log("ğŸ® éŠæˆ²é–‹å§‹ï¼å…± 50 å›åˆï¼Œç¥ä½ å¥½é‹ï¼");
  startBtn.disabled = true;
  startBtn.style.display = "none";   // æŒ‰ä¸‹é–‹å§‹å¾Œéš±è—é–‹å§‹æŒ‰éˆ•
  nextBtn.style.display = "inline-block";
  leaveBtn.style.display = "inline-block";
  nextEvent();
}


    function restartGame() {
      turn = 0;
      goldReserve = 0;
      gameOver = false;
      players.forEach((p) => {
        p.gold = 0;
        p.luck = { defense: 0, bonus: 0 };
        p.bad = { trap: 0, zombie: 0, poison: 0 };
        p.alive = true;
        p.left = false;
      });
      logEl.textContent = "";
      updateUI();
      startBtn.disabled = false;
      startBtn.style.display = "inline-block";
      nextBtn.style.display = "none";
      leaveBtn.style.display = "none";
      restartBtn.style.display = "none";
    }

   function startCountdown() {
// ç©å®¶Aï¼ˆä½ ï¼‰
  const self = players[0];
  // è‹¥è‡ªå·±å·²é›¢é–‹æˆ–AIè¨—ç®¡ï¼Œå€’æ•¸æ”¹ç‚º 5~10 ç§’
  if ((self.left && self.alive) || !self.alive || self.isAI) {
    countdown = Math.floor(Math.random() * 6) + 5; // 5~10ç§’
    nextBtn.style.display = "inline-block";
  } else {
    countdown = 60;
    nextBtn.style.display = "inline-block";
  }
  nextBtn.textContent = `â­ï¸ ä¸‹ä¸€æ­¥ï¼ˆ${countdown}sï¼‰`;
  countdownTimer = setInterval(() => {
    countdown--;
    nextBtn.textContent = `â­ï¸ ä¸‹ä¸€æ­¥ï¼ˆ${countdown}sï¼‰`;
    if (countdown <= 0) {
      clearInterval(countdownTimer);
      nextEvent();
    }
  }, 1000);
}

    function nextEvent() {
      clearInterval(countdownTimer);
      nextBtn.style.display = "inline-block";

      if (checkGameOver()) return;

      turn++;
      log(`\nğŸ² ç¬¬ ${turn} å›åˆé–‹å§‹`);

      const event = events[Math.floor(Math.random() * events.length)];
      event();

      startCountdown();
    }

    function manualNextEvent() {
      clearInterval(countdownTimer);
      nextEvent();
    }

    function toggleRules() {
      if (rulesPanel.style.display === "none" || rulesPanel.style.display === "") {
        rulesPanel.style.display = "block";
      } else {
        rulesPanel.style.display = "none";
      }
    }

    function startLeaveCountdown() {
      let leaveCountdown = 60;
      const leaveInterval = setInterval(() => {
        leaveCountdown--;
        if (leaveCountdown <= 0) {
          clearInterval(leaveInterval);
          leaveBtn.style.display = "none";
          nextEvent();
        }
      }, 1000);
    }

    // æ–°å¢ï¼šè¨˜éŒ„è¶…ç´šé‡‘å¡Šäº‹ä»¶æ˜¯å¦å·²è§¸ç™¼
let superGoldEvents = {
  1: false, // 10~15
  2: false, // 20~25
  3: false  // 30~35
};



// æ–°å¢ï¼šè¶…ç´šé‡‘å¡Šäº‹ä»¶
// ...existing code...
function superGoldEvent(period) {
  
  log("ğŸŒŸ ç™¼ç¾è¶…ç´šé‡‘å¡Šå¯¶è—ï¼30 é¡†é‡‘å¡Šï¼Œåªæœ‰é€™æ¬¡é¸æ“‡é›¢é–‹çš„ç©å®¶æ‰èƒ½ç²å¾—ï¼");
  superGoldEvents[period] = true;

  let superGoldLeavers = [];
 if (!players[0].alive || players[0].left) {
  // ç©å®¶Aå·²æ­»äº¡æˆ–é›¢é–‹ï¼Œç”±å…©ä½AIé¸æ“‡
   countdown = 20; // é‡ç½®å€’æ•¸è¨ˆæ™‚
  log("ç©å®¶Aå·²æ­»äº¡æˆ–é›¢é–‹ï¼Œæ”¹ç”±å…©ä½AIé€²è¡Œè¶…ç´šé‡‘å¡Šé¸æ“‡ï¼");
  aiChooseTwo();
} else {
  aiChoose();
}


  // ç©å®¶è‡ªå·±æ±ºå®š
  leaveBtn.style.display = "inline-block";
  leaveBtn.onclick = function () {
    players[0].left = true;
    superGoldLeavers.push(players[0]);
    log(`ğŸšª ${players[0].name} é¸æ“‡é›¢é–‹ï¼Œå°‡åƒèˆ‡è¶…ç´šé‡‘å¡Šåˆ†é…ï¼`);
    leaveBtn.style.display = "none";
    leaveBtn.onclick = playerLeave;
   
  };

// 60ç§’å…§æ²’é¸ï¼Œè¦–ç‚ºä¸é›¢é–‹
setTimeout(() => {
  leaveBtn.style.display = "none";
  leaveBtn.onclick = playerLeave;
  if (!players[0].left && players[0].alive) {
    log(`â° ${players[0].name} æœªé¸æ“‡é›¢é–‹ï¼Œç¹¼çºŒå†’éšªï¼`);
  
  } else {
    // ç©å®¶Aå·²æ­»äº¡æˆ–é›¢é–‹ï¼Œç”±å…©ä½AIé¸æ“‡
    log("ç©å®¶Aå·²æ­»äº¡æˆ–é›¢é–‹ï¼Œæ”¹ç”±å…©ä½AIé€²è¡Œè¶…ç´šé‡‘å¡Šé¸æ“‡ï¼");

  }
}, 60000);

function aiChooseTwo() {
  const aiCandidates = players.filter(p => p.isAI && p.alive && !p.left);
  const shuffled = aiCandidates.sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, 2);

  let aiIndex = 0;
  function aiNext() {
    if (aiIndex >= selected.length) {
      distributeSuperGold();
      return;
    }
    const ai = selected[aiIndex];
    let aiCountdown = 10;
    log(`ğŸ¤– ${ai.name} æ­£åœ¨è€ƒæ…®æ˜¯å¦é›¢é–‹...ï¼ˆå‰©é¤˜ ${aiCountdown} ç§’ï¼‰`);
    const aiInterval = setInterval(() => {
      aiCountdown--;
      log(`ğŸ¤– ${ai.name} æ­£åœ¨è€ƒæ…®æ˜¯å¦é›¢é–‹...ï¼ˆå‰©é¤˜ ${aiCountdown} ç§’ï¼‰`);
      if (aiCountdown <= 0) {
        clearInterval(aiInterval);

        let leaveChance = 0.5;
        if (ai.gold >= 15) leaveChance += 0.2;
        if (ai.gold >= 25) leaveChance += 0.2;
        const sorted = [...players].sort((a, b) => b.gold - a.gold);
        const rank = sorted.findIndex(pl => pl === ai) + 1;
        if (rank <= 2) leaveChance += 0.2;

        if (Math.random() < leaveChance) {
          ai.left = true;
          superGoldLeavers.push(ai);
          log(`ğŸ¤– ${ai.name} æ±ºå®šé›¢é–‹ï¼Œå°‡åƒèˆ‡è¶…ç´šé‡‘å¡Šåˆ†é…ï¼ï¼ˆé‡‘å¡Šï¼š${ai.gold}ï¼Œæ’åï¼š${rank}ï¼‰`);
        } else {
          log(`ğŸ¤– ${ai.name} æ±ºå®šç¹¼çºŒå†’éšªï¼Œæ”¾æ£„è¶…ç´šé‡‘å¡Šï¼ï¼ˆé‡‘å¡Šï¼š${ai.gold}ï¼Œæ’åï¼š${rank}ï¼‰`);
        }
        aiIndex++;
        aiNext();
      }
    }, 1000);
  }
  aiNext();
}

  // AI æ±ºå®š
 function aiChoose() {
  const aiCandidates = players.filter(p => p.isAI && p.alive && !p.left);
  if (aiCandidates.length > 0) {
    const ai = aiCandidates[Math.floor(Math.random() * aiCandidates.length)];
    let aiCountdown = 5;
    log(`ğŸ¤– ${ai.name} æ­£åœ¨è€ƒæ…®æ˜¯å¦é›¢é–‹...ï¼ˆå‰©é¤˜ ${aiCountdown} ç§’ï¼‰`);
    const aiInterval = setInterval(() => {
      aiCountdown--;
      log(`ğŸ¤– ${ai.name} æ­£åœ¨è€ƒæ…®æ˜¯å¦é›¢é–‹...ï¼ˆå‰©é¤˜ ${aiCountdown} ç§’ï¼‰`);
      if (aiCountdown <= 0) {
        clearInterval(aiInterval);

        // åŸºæœ¬é›¢é–‹æ©Ÿç‡
        let leaveChance = 0.5;

        // ä¾æ“šç›®å‰é‡‘å¡Šæ•¸é‡æé«˜æ©Ÿç‡ï¼ˆä¾‹å¦‚é‡‘å¡Šè¶…é15é¡†å†+0.2ï¼Œè¶…é25é¡†å†+0.2ï¼‰
        if (ai.gold >= 15) leaveChance += 0.2;
        if (ai.gold >= 25) leaveChance += 0.2;

        // ä¾æ“šç›®å‰æ’åï¼ˆå‰2åå†+0.2ï¼‰
        const sorted = [...players].sort((a, b) => b.gold - a.gold);
        const rank = sorted.findIndex(pl => pl === ai) + 1;
        if (rank <= 2) leaveChance += 0.2;

        // æ±ºå®šæ˜¯å¦é›¢é–‹
        if (Math.random() < leaveChance) {
          ai.left = true;
          superGoldLeavers.push(ai);
          log(`ğŸ¤– ${ai.name} æ±ºå®šé›¢é–‹ï¼Œå°‡åƒèˆ‡è¶…ç´šé‡‘å¡Šåˆ†é…ï¼ï¼ˆé‡‘å¡Šï¼š${ai.gold}ï¼Œæ’åï¼š${rank}ï¼‰`);
        } else {
          log(`ğŸ¤– ${ai.name} æ±ºå®šç¹¼çºŒå†’éšªï¼Œæ”¾æ£„è¶…ç´šé‡‘å¡Šï¼ï¼ˆé‡‘å¡Šï¼š${ai.gold}ï¼Œæ’åï¼š${rank}ï¼‰`);
        }
        distributeSuperGold();
      }
    }, 1000);
  } else {
    distributeSuperGold();
  }
}

  // åˆ†é…è¶…ç´šé‡‘å¡Š
  function distributeSuperGold() {
    if (superGoldLeavers.length > 0) {
      const each = Math.floor(30 / superGoldLeavers.length);
      superGoldLeavers.forEach(p => {
        p.gold += each;
        log(`ğŸ† ${p.name} ç²å¾—è¶…ç´šé‡‘å¡Š ${each} é¡†ï¼`);
      });
      const leftover = 30 % superGoldLeavers.length;
      if (leftover > 0) {
        goldReserve += leftover;
        log(`å‰©é¤˜ ${leftover} é¡†é‡‘å¡Šé€²å…¥ä¿ç•™å€ (${goldReserve})ã€‚`);
      }
    } else {
      goldReserve += 30;
      log("ğŸ˜¢ æ²’æœ‰äººé¸æ“‡é›¢é–‹ï¼Œè¶…ç´šé‡‘å¡Šé€²å…¥ä¿ç•™å€ï¼");
    }
    updateUI();
  }
}
// ...existing code...

// ä¿®æ”¹ nextEventï¼Œæ’å…¥è¶…ç´šé‡‘å¡Šäº‹ä»¶
function nextEvent() {
  clearInterval(countdownTimer);
  nextBtn.style.display = "inline-block";

  

  if (checkGameOver()) return;

  turn++;
  log(`\nğŸ² ç¬¬ ${turn} å›åˆé–‹å§‹`);

  // è¶…ç´šé‡‘å¡Šäº‹ä»¶æ©Ÿç‡
  if (!superGoldEvents[1] && turn >= 10 && turn <= 15 && Math.random() < 0.2) {
    superGoldEvent(1);
    startCountdown();
    return;
  }
  if (!superGoldEvents[2] && turn >= 20 && turn <= 25 && Math.random() < 0.2) {
    superGoldEvent(2);
    startCountdown();
    return;
  }
  if (!superGoldEvents[3] && turn >= 30 && turn <= 35 && Math.random() < 0.2) {
    superGoldEvent(3);
    startCountdown();
    return;
  }

  // å‹•æ…‹çµ„åˆäº‹ä»¶æ± 
  let eventPool = [...events];
  if (getLeftPlayers().length > 0) {
    eventPool.push(() => leftPlayerRandomEvent());
  }

  const event = eventPool[Math.floor(Math.random() * eventPool.length)];
  event();

  startCountdown();
}

    const events = [
      () => goldEvent(5),
      () => goldEvent(10),
       () => goldEvent(12),
        () => goldEvent(18),
         () => goldEvent(20),
      () => luckEvent(),
      () => luckEvent(),
      () => misfortuneEvent("trap", "æ‰é€²é™·é˜±"),
      () => misfortuneEvent("zombie", "é‡åˆ°æ®­å±"),
      () => misfortuneEvent("poison", "æ¯’èŸ²å’¬å‚·"),
    ];

    function updateMyTotalGold() {
  const total = localStorage.getItem("myTotalGold") || "0";
  document.getElementById("myTotalGold").textContent = total;
}



    updateUI();
    updateMyTotalGold();
  </script>
</body>
</html>