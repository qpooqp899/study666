<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æˆ¿é–“å¸ƒç½®éŠæˆ²</title>
  <!-- <link rel="manifest" href="manifest.json"> -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f3f3f3;
      height: 100%;
    }
    #topMenu {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      background: #eee;
      padding: 10px;
    }
    .roomBtn { padding: 5px 10px; background: #ddd; border-radius: 5px; cursor: pointer; margin: 4px; }
    #roomArea {
      width: 100%;
      height: 400px;
      border: 1px solid #aaa;
      position: relative;
      background: #fff;
      overflow: hidden;
      touch-action: none;
    }
    .grid-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-image: linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: 10;
    }
    #store, #inventory {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px;
      background: #ccc;
    }
    .item {
      width: 50px;
      height: 50px;
      cursor: grab;
      background: transparent;
      text-align: center;
      line-height: 50px;
      border: 1px solid #999;
      border-radius: 6px;
      touch-action: none;
    }
    .furniture {
      position: absolute;
      text-align: center;
      line-height: 50px;
      background: transparent;
      border-radius: 8px;
      user-select: none;
      touch-action: none;
      transform: scale(2) rotate(0deg);
      font-size: 32px;
    }
    #furnitureMenu {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #aaa;
      border-radius: 10px;
      padding: 10px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #furnitureMenu button {
      margin: 5px;
      padding: 6px 14px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #confirmModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #confirmBox {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    input[type=range] {
      width: 100%;
    }
    #gridToggleBtn, #snapshotBtn, #colorToggleBtn {
      background: #888;
      color: #fff;
      border-radius: 6px;
      padding: 5px 10px;
      margin: 5px;
      cursor: pointer;
    }
    #colorPanel {
      display: none;
      flex-direction: column;
      align-items: stretch;
      padding: 10px;
      background: #eee;
    }
    #colorPanel label { font-size: 12px; }
    @media (max-width: 768px) {
      #roomArea { height: 300px; }
      .furniture { font-size: 28px; }
    }
  #store {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px 0;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
    }

    .item {
      flex: 0 0 auto;
      width: 120px;
      height: 120px;
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      scroll-snap-align: start;
      text-align: center;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s;
    }

    .item:hover {
      transform: scale(1.05);
    }

   
/* æ¡Œæ©Ÿé è¨­ï¼šæ©«å‘è¡¨æ ¼æ’åˆ— */
.item-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  overflow-x: auto;
}

.item-td {
  border: 1px solid #ccc;
  text-align: center;
  padding: 8px;
  min-width: 120px;
}

.item-card .icon {
  font-size: 24px;
}

.item-card .price {
  margin: 4px 0;
  font-weight: bold;
}

.buy-btn {
  padding: 4px 10px;
  background-color: #4caf50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.buy-btn:hover {
  background-color: #45a049;
}

/* âœ… æ‰‹æ©Ÿæ¨¡å¼ï¼šæ©«å‘å¡ç‰‡å¯æ»‘å‹• */
@media (max-width: 768px) {
  .item-table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  .item-table tr {
    display: flex;
  }

  .item-td {
    display: inline-block;
    width: 140px;
    white-space: normal;
    border: none;
  }

  .item-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f8f8f8;
    border-radius: 10px;
    padding: 10px;
    margin: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  
  
}





  </style>
  <style>
.inventory-container {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
  gap: 8px;
  padding: 10px;
}

/* å–®å€‹å¡ç‰‡æ¨£å¼ */
.inventory-card {
  flex: 0 0 auto;
  width: 100px;
  background: #f1f1f1;
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  cursor: grab;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.inventory-card .icon {
  font-size: 28px;
}

.inventory-card .quantity {
  margin-top: 6px;
  font-weight: bold;
  color: #333;
}
</style>


</head>
<body>
  <div id="topMenu">
    <div class="roomBtn" onclick="switchRoom(1)">1æ¨“</div>
    <div class="roomBtn" onclick="unlockRoom(2)">2æ¨“</div>
    <div class="roomBtn" onclick="unlockRoom(3)">3æ¨“</div>
    <div id="gridToggleBtn" onclick="toggleGrid()">æ ¼ç·šï¼šé–‹/é—œ</div>
    <div id="snapshotBtn" onclick="takeSnapshot()">ğŸ“¸ å„²å­˜å¿«ç…§</div>
    <div id="colorToggleBtn" onclick="toggleColorPanel()">ğŸ¨ åœ°æ¿é¡è‰²</div>
    <div>ğŸ’° é‡‘å¹£ï¼š<span id="coinDisplay">0</span></div>
  </div>
  <div id="roomArea" ondrop="drop(event)" ondragover="allowDrop(event)"></div>

    <div id="colorPanel">
    <label>ç´…ï¼š<input type="range" id="rRange" min="0" max="255" value="255"></label>
    <label>ç¶ ï¼š<input type="range" id="gRange" min="0" max="255" value="255"></label>
    <label>è—ï¼š<input type="range" id="bRange" min="0" max="255" value="255"></label>
    <label>é€æ˜åº¦ï¼š<input type="range" id="aRange" min="0" max="1" step="0.01" value="1"></label>
  </div>
<!-- å®¶å…·é¸å–® -->
<div id="furnitureMenu">
  <div>ğŸª‘ <span id="menuItemName"></span></div>
  <button id="moveBtn" onclick="startMove()">ç§»å‹•</button>
  <button onclick="rotateFurniture()">æ—‹è½‰</button>
  <button onclick="flipFurniture()">æ°´å¹³ç¿»è½‰</button>
  <input type="range" min="0.5" max="2" step="0.1" value="2" oninput="setFurnitureScale(this.value)">
  <button id="lockBtn" onclick="toggleLockFurniture()">é–å®š/è§£é–</button>
  <button style="background:#f55;color:#fff" onclick="confirmDeleteFurniture()">åˆªé™¤</button>
  <button onclick="closeMenu()">å–æ¶ˆ</button>
</div>

<!-- åˆªé™¤ç¢ºèªè¦–çª— -->
<div id="confirmModal">
  <div id="confirmBox">
    <p>ç¢ºå®šè¦åˆªé™¤é€™å€‹å®¶å…·å—ï¼Ÿ</p>
    <button onclick="deleteFurniture()">ç¢ºå®š</button>
    <button onclick="closeConfirm()">å–æ¶ˆ</button>
  </div>
</div>
<div style="display: flex; align-items: center; gap: 10px;">
  <h3 style="margin: 0;">ğŸ  å•†åŸ</h3>
  <label for="categorySelect">ç¯©é¸åˆ†é¡ï¼š</label>
  <select id="categorySelect">
   <option value="å…¨éƒ¨">å…¨éƒ¨</option>
    <option value="å®¶ä¿±">å®¶ä¿±</option>
    <option value="å®¶é›»">å®¶é›»</option>
    <option value="è£é£¾">è£é£¾</option>
    <option value="äººç‰©">äººç‰©</option>
    <option value="å¯µç‰©">å¯µç‰©</option>
    <option value="å»šæˆ¿">å»šæˆ¿</option>
    <option value="è¡›æµ´">è¡›æµ´</option>
    <option value="å…¶ä»–">å…¶ä»–</option>
  </select>
</div>
<div id="store"></div>
<div style="display: flex; align-items: center; gap: 10px;">
  <h3 style="margin: 0;">ğŸ‘œ å·²è³¼æ¸…å–®</h3>
  <label for="inventoryFilter">åˆ†é¡ï¼š</label>
  <select id="inventoryFilter">
      <option value="å…¨éƒ¨">å…¨éƒ¨</option>
    <option value="å®¶ä¿±">å®¶ä¿±</option>
    <option value="å®¶é›»">å®¶é›»</option>
    <option value="è£é£¾">è£é£¾</option>
    <option value="äººç‰©">äººç‰©</option>
    <option value="å¯µç‰©">å¯µç‰©</option>
    <option value="å»šæˆ¿">å»šæˆ¿</option>
    <option value="è¡›æµ´">è¡›æµ´</option>
    <option value="å…¶ä»–">å…¶ä»–</option>
  </select>
</div>
  <div id="inventory"></div>

  <script>

const items = [
  { name: "æ²™ç™¼", price: 200, icon: "ğŸ›‹ï¸" ,category: "å®¶ä¿±"},
  { name: "æ¡Œå­", price: 200, icon: "ğŸª‘" ,category: "å®¶ä¿±"},
  { name: "åºŠ", price: 200, icon: "ğŸ›ï¸" ,category: "å®¶ä¿±"},
  { name: "éš”æ¿-", price: 50, icon: " â–" ,category: "è£é£¾"},
  { name: "éš”æ¿+", price: 50, icon: " â•" ,category: "è£é£¾"},
  { name: "æ„›å¿ƒ", price: 50, icon: "â¤ï¸" ,category: "è£é£¾"},
  { name: "è²“", price: 1500, icon: "ğŸˆ" ,category: "å¯µç‰©"},
  { name: "å°å¯¶å¯¶", price: 150, icon: "ğŸ‘¶" ,category: "äººç‰©"},
  { name: "å¥³å­©", price: 150, icon: "ğŸ‘§" ,category: "äººç‰©"},
  { name: "ç”·å­©", price: 150, icon: "ğŸ‘¦" ,category: "äººç‰©"},
  { name: "å¤§äºº", price: 150, icon: "ğŸ§‘" ,category: "äººç‰©"},
  { name: "å¥³äºº", price: 150, icon: "ğŸ‘©" ,category: "äººç‰©"},
    { name:"æ™‚é˜",price :150,icon:"â°", category:"è£é£¾"},
  { name: "é¤æ¡Œ", price: 500, icon: "ğŸ½ï¸" ,category: "å®¶ä¿±"},
  { name: "æ”¶ç´æ«ƒ", price: 600, icon: "ğŸ—„ï¸" ,category: "å®¶ä¿±"},  
  { name: "é›»é¢¨æ‰‡", price: 300, icon: "ğŸŒ€" ,category: "å®¶é›»"},
  { name: "ç©ºèª¿", price: 800, icon: "â„ï¸" ,category: "å®¶é›»"},
  { name: "é›»æš–å™¨", price: 800, icon: "ğŸ”¥" ,category: "å®¶é›»"},
    { name: "é›»è¦–", price: 500, icon: "ğŸ“º" ,category: "å®¶é›»"},
    { name: "å†°ç®±", price: 500, icon: "ğŸ§Š" ,category: "å®¶é›»"},
    { name: "é›»è…¦", price: 500, icon: "ğŸ’»" ,category: "å®¶é›»"},
    { name: "è¡£æ«ƒ", price: 500, icon: "ğŸšª" ,category: "å®¶ä¿±"},
    { name: "æ›¸æ«ƒ", price: 500, icon: "ğŸ“š" ,category: "å®¶ä¿±"},
    { name: "ç‡ˆ", price: 500, icon: "ğŸ’¡" ,category: "å®¶é›»"},
    { name: "åœ°æ¯¯", price: 500, icon: "ğŸ§¶" ,category: "è£é£¾"},
    { name: "é¦¬æ¡¶", price: 500, icon: "ğŸš½" ,category: "è¡›æµ´"},
    { name: "æ´—æ‰‹å°", price: 500, icon: "ğŸš°" ,category: "è¡›æµ´"},
    { name: "æµ´ç¼¸", price: 500, icon: "ğŸ›" ,category: "è¡›æµ´"},
    { name:"å»šæˆ¿çˆå…·",price :500,icon:"ğŸ³", category:"å»šæˆ¿"},
    { name:"å¾®æ³¢çˆ",price :500,icon:"ğŸ”Œ", category:"å»šæˆ¿"},
    { name:"ç©ºæ°£æ¸…æ·¨æ©Ÿ",price :500,icon:"ğŸŒ¬ï¸", category:"å®¶é›»"},
    { name:"ç•«ä½œ",price :500,icon:"ğŸ–¼ï¸", category:"è£é£¾"},
    { name:"æ™‚é˜",price :500,icon:"ğŸ•°ï¸", category:"è£é£¾"},
    { name:"éŸ³éŸ¿",price :500,icon:"ğŸ”Š", category:"å®¶é›»"},
    { name: "è±¬", price: 1500, icon: "ğŸ–" ,category: "å¯µç‰©"}

];

    let coins = parseInt(localStorage.getItem('coins')) || 0;
    localStorage.setItem('coins', coins);
    let unlockedRooms = JSON.parse(localStorage.getItem('unlockedRooms')) || [1];
    let currentRoom = 1;
    let inventory = JSON.parse(localStorage.getItem('inventory')) || {};
    let roomData = JSON.parse(localStorage.getItem('roomData')) || {};
    let selectedFurniture = null;
    let moveMode = false;

    const coinDisplay = document.getElementById("coinDisplay");
    const store = document.getElementById("store");
    const inventoryEl = document.getElementById("inventory");
    const roomArea = document.getElementById("roomArea");
    const menuEl = document.getElementById("furnitureMenu");
    const modalEl = document.getElementById("confirmModal");
    const menuItemName = document.getElementById("menuItemName");

    let gridVisible = false;
    function toggleGrid() {
      gridVisible = !gridVisible;
      let grid = document.querySelector(".grid-overlay");
      if (!grid && gridVisible) {
        grid = document.createElement("div");
        grid.className = "grid-overlay";
        roomArea.appendChild(grid);
      } else if (grid && !gridVisible) {
        grid.remove();
      }
    }

    function updateCoins(amount) {
      coins += amount;
      localStorage.setItem("coins", coins);
      coinDisplay.textContent = coins;
    }

    function unlockRoom(roomNum) {
      if (unlockedRooms.includes(roomNum)) return switchRoom(roomNum);
      if (coins >= 50000) {
        updateCoins(-50000);
        unlockedRooms.push(roomNum);
        localStorage.setItem("unlockedRooms", JSON.stringify(unlockedRooms));
        switchRoom(roomNum);
      } else alert("é‡‘å¹£ä¸è¶³ï¼è§£é–éœ€è¦5è¬é‡‘å¹£");
    }

    function switchRoom(num) {
      if (!unlockedRooms.includes(num)) return alert("å°šæœªè§£é–");
      currentRoom = num;
      roomArea.innerHTML = '';
      loadRoomFurniture();
    }

    function loadStore() {
// const items = [
//   { name: "æ²™ç™¼", price: 0, icon: "ğŸ›‹ï¸" ,category: "å®¶ä¿±"},
//   { name: "æ¡Œå­", price: 0, icon: "ğŸª‘" ,category: "å®¶ä¿±"},
//   { name: "åºŠ", price: 200, icon: "ğŸ›ï¸" ,category: "å®¶ä¿±"},
//   { name: "éš”æ¿-", price: 50, icon: " â–" ,category: "è£é£¾"},
//   { name: "éš”æ¿+", price: 50, icon: " â•" ,category: "è£é£¾"},
//   { name: "æ„›å¿ƒ", price: 50, icon: "â¤ï¸" ,category: "è£é£¾"},
//   { name: "è²“", price: 1500, icon: "ğŸˆ" ,category: "å¯µç‰©"},
//   { name: "å°å¯¶å¯¶", price: 150, icon: "ğŸ‘¶" ,category: "äººç‰©"},
//   { name: "å¥³å­©", price: 150, icon: "ğŸ‘§" ,category: "äººç‰©"},
//   { name: "ç”·å­©", price: 150, icon: "ğŸ‘¦" ,category: "äººç‰©"},
//   { name: "å¤§äºº", price: 150, icon: "ğŸ§‘" ,category: "äººç‰©"},
//   { name: "å¥³äºº", price: 150, icon: "ğŸ‘©" ,category: "äººç‰©"},
//     { name:"æ™‚é˜",price :150,icon:"â°", category:"è£é£¾"},
//   { name: "é¤æ¡Œ", price: 500, icon: "ğŸ½ï¸" ,category: "å®¶ä¿±"},
//   { name: "æ”¶ç´æ«ƒ", price: 600, icon: "ğŸ—„ï¸" ,category: "å®¶ä¿±"},  
//   { name: "é›»é¢¨æ‰‡", price: 300, icon: "ğŸŒ€" ,category: "å®¶é›»"},
//   { name: "ç©ºèª¿", price: 800, icon: "â„ï¸" ,category: "å®¶é›»"},
//   { name: "é›»æš–å™¨", price: 800, icon: "ğŸ”¥" ,category: "å®¶é›»"},
//     { name: "é›»è¦–", price: 500, icon: "ğŸ“º" ,category: "å®¶é›»"},
//     { name: "å†°ç®±", price: 500, icon: "ğŸ§Š" ,category: "å®¶é›»"},
//     { name: "é›»è…¦", price: 500, icon: "ğŸ’»" ,category: "å®¶é›»"},
//     { name: "è¡£æ«ƒ", price: 500, icon: "ğŸšª" ,category: "å®¶ä¿±"},
//     { name: "æ›¸æ«ƒ", price: 500, icon: "ğŸ“š" ,category: "å®¶ä¿±"},
//     { name: "ç‡ˆ", price: 500, icon: "ğŸ’¡" ,category: "å®¶é›»"},
//     { name: "åœ°æ¯¯", price: 500, icon: "ğŸ§¶" ,category: "è£é£¾"},
//     { name: "é¦¬æ¡¶", price: 500, icon: "ğŸš½" ,category: "è¡›æµ´"},
//     { name: "æ´—æ‰‹å°", price: 500, icon: "ğŸš°" ,category: "è¡›æµ´"},
//     { name: "æµ´ç¼¸", price: 500, icon: "ğŸ›" ,category: "è¡›æµ´"},
//     { name:"å»šæˆ¿çˆå…·",price :500,icon:"ğŸ³", category:"å»šæˆ¿"},
//     { name:"å¾®æ³¢çˆ",price :500,icon:"ğŸ”Œ", category:"å»šæˆ¿"},
//     { name:"ç©ºæ°£æ¸…æ·¨æ©Ÿ",price :500,icon:"ğŸŒ¬ï¸", category:"å®¶é›»"},
//     { name:"ç•«ä½œ",price :500,icon:"ğŸ–¼ï¸", category:"è£é£¾"},
//     { name:"æ™‚é˜",price :500,icon:"ğŸ•°ï¸", category:"è£é£¾"},
//     { name:"éŸ³éŸ¿",price :500,icon:"ğŸ”Š", category:"å®¶é›»"},
//     { name: "è±¬", price: 1500, icon: "ğŸ–" ,category: "å¯µç‰©"}

// ];



    //   store.innerHTML = '';
    //   items.forEach(item => {
    //     const div = document.createElement("div");
    //     div.className = "item";
    //     div.innerHTML = `${item.icon}<br>$${item.price}`;
    //     div.onclick = () => {
    //       if (coins >= item.price) {
    //         updateCoins(-item.price);
    //         inventory[item.name] = inventory[item.name] || { icon: item.icon, quantity: 0 };
    //         inventory[item.name].quantity++;
    //         localStorage.setItem("inventory", JSON.stringify(inventory));
    //         loadInventory();
    //       } else alert("é‡‘å¹£ä¸è¶³");
    //     };
    //     store.appendChild(div);
    //   });

    //  store.innerHTML = '';
    //   items.forEach(item => {
    //     const div = document.createElement("div");
    //     div.className = "item";
    //     div.innerHTML = `${item.icon}<br>$${item.price}`;
    //     div.onclick = () => {
    //       if (coins >= item.price) {
    //         updateCoins(-item.price);
    //         inventory[item.name] = inventory[item.name] || { icon: item.icon, quantity: 0 };
    //         inventory[item.name].quantity++;
    //         localStorage.setItem("inventory", JSON.stringify(inventory));
           
    //       } else {
    //         alert("é‡‘å¹£ä¸è¶³ï¼");
    //       }
    //     };
    //     store.appendChild(div);
    //   });

//   store.innerHTML = '';

// const table = document.createElement("table");
// table.className = "item-table"; // çµ¦äºˆ class æ–¹ä¾¿ CSS æ§åˆ¶

// const tr = document.createElement("tr");

// items.forEach(item => {
//   const td = document.createElement("td");
//   td.className = "item-td";

//   td.innerHTML = `
//     <div class="item-card">
//       <div class="icon">${item.icon}</div>
//       <div class="price">$${item.price}</div>
     
//     </div>
//   `;

//   td.querySelector(".item-card").onclick = () => {
//     if (coins >= item.price) {
//       updateCoins(-item.price);
//       inventory[item.name] = inventory[item.name] || { icon: item.icon, quantity: 0 };
//       inventory[item.name].quantity++;
//       localStorage.setItem("inventory", JSON.stringify(inventory));
//       loadInventory();
//     } else {
//       alert("é‡‘å¹£ä¸è¶³ï¼");
//     }
//   };

//   tr.appendChild(td);
// });

// table.appendChild(tr);
// store.appendChild(table);

function renderStore(category = "å…¨éƒ¨") {
  store.innerHTML = '';

  const table = document.createElement("table");
  table.className = "item-table";

  const tr = document.createElement("tr");

  const filteredItems = category === "å…¨éƒ¨"
    ? items
    : items.filter(item => item.category === category);

  filteredItems.forEach(item => {
    const td = document.createElement("td");
    td.className = "item-td";

    td.innerHTML = `
      <div class="item-card">
        <div class="icon">${item.icon}</div>
        <div class="price">$${item.price}</div>
      </div>
    `;

    td.querySelector(".item-card").onclick = () => {
      if (coins >= item.price) {
        updateCoins(-item.price);
        inventory[item.name] = inventory[item.name] || { icon: item.icon, quantity: 0 };
        inventory[item.name].quantity++;
        localStorage.setItem("inventory", JSON.stringify(inventory));
        loadInventory();
      } else {
        alert("é‡‘å¹£ä¸è¶³ï¼");
      }
    };

    tr.appendChild(td);
  });

  table.appendChild(tr);
  store.appendChild(table);
}
    document.getElementById("categorySelect").addEventListener("change", (e) => {
  const selectedCategory = e.target.value;
  renderStore(selectedCategory);
});
    renderStore(); // é è¨­è¼‰å…¥å…¨éƒ¨åˆ†é¡

    }



    // function loadInventory() {
    //   inventoryEl.innerHTML = '';
    //   Object.keys(inventory).forEach(name => {
    //     const item = inventory[name];
    //     const div = document.createElement("div");
    //     div.className = "item";
    //     div.draggable = true;
       
    //         div.dataset.name = name;  // ğŸ‘ˆ é—œéµï¼šä¸€å®šè¦è¨­
    //     div.dataset.icon = item.icon;  // ğŸ‘ˆ å„²å­˜åœ–ç¤º
    //     div.textContent = `${item.icon} x${item.quantity}`;
    //     div.ondragstart = e => e.dataTransfer.setData("text", name);
    //     inventoryEl.appendChild(div);
    //   });
    // }

//     function loadInventory() {
//   inventoryEl.innerHTML = '';

//   const container = document.createElement("div");
//   container.className = "inventory-container";

//   Object.keys(inventory).forEach(name => {
//     const item = inventory[name];

//     const card = document.createElement("div");
//     card.className = "inventory-card";
//     card.draggable = true;

//     card.dataset.name = name;
//     card.dataset.icon = item.icon;

//     card.innerHTML = `
//       <div class="icon">${item.icon}</div>
//       <div class="quantity">x${item.quantity}</div>
//     `;

//     card.ondragstart = e => e.dataTransfer.setData("text", name);

//     container.appendChild(card);
//   });

//   inventoryEl.appendChild(container);
// }

   

function loadInventory(category = "å…¨éƒ¨") {
  inventoryEl.innerHTML = '';

  const table = document.createElement("div");
  table.className = "item-table";

  const tr = document.createElement("tr");

  // ç¯©é¸å‡ºè³¼è²·æ¸…å–®ä¸­ç¬¦åˆåˆ†é¡çš„ç‰©å“åç¨±
  const filteredNames = Object.keys(inventory).filter(name => {
    const itemData = items.find(i => i.name === name);
    if (!itemData) return false;
    if (category === "å…¨éƒ¨") return true;
    return itemData.category === category;
  });

  filteredNames.forEach(name => {
    const itemData = items.find(i => i.name === name);
    const itemInv = inventory[name];
    console.log(itemData, itemInv);
    if (!itemData) return;

    const td = document.createElement("td");
    td.className = "inventory-card";

        td.draggable = true;

    td.dataset.name = itemData.name;  // å„²å­˜åç¨±
    td.dataset.icon = itemData.icon; // å„²å­˜åœ–ç¤º 

    td.innerHTML = `
      <div class="item-card">
        <div class="icon">${itemData.icon}</div>
        <div class="quantity">x ${itemInv.quantity} </div>
      </div>
    `;
    td.ondragstart = e => e.dataTransfer.setData("text", name);

    tr.appendChild(td);
  });

  table.appendChild(tr);
  inventoryEl.appendChild(table);
}


  

    // ç›£è½åˆ†é¡é¸æ“‡è®Šæ›´
    document.getElementById("inventoryFilter").addEventListener("change", (e) => {
      const selectedCategory = e.target.value;
      loadInventory(selectedCategory);
    });








    function allowDrop(e) { e.preventDefault(); }

    // æ‹–æ›³æ”¾ç½®å®¶å…·
    function drop(e) {
      e.preventDefault();
      const name = e.dataTransfer.getData("text");
      const item = inventory[name];
      if (!item || item.quantity <= 0) return;
      const div = document.createElement("div");
      div.className = "furniture";
      div.textContent = item.icon;  
      div.style.left = `${e.offsetX}px`;
      div.style.top = `${e.offsetY}px`;
      div.dataset.name = name;
      div.dataset.scale = "2"; // é è¨­ç¸®æ”¾
      div.dataset.rotate = 0;
      div.dataset.locked = "false";
      div.dataset.flip = "1"; // æ–°å¢é€™è¡Œ
      
      div.style.transform = `scale(2) rotate(0deg)`; //ç•«é¢å®¶å…·é è¨­æ”¾å¤§2å€

      makeFurnitureInteractive(div);
      roomArea.appendChild(div);
      
             
                 item.quantity--;

   

    //   if (item.quantity <= 0) delete inventory[name];

localStorage.setItem("inventory", JSON.stringify(inventory));

  roomData[currentRoom] = roomData[currentRoom] || [];
  roomData[currentRoom].push({
    name,
    x: e.offsetX,
    y: e.offsetY,
    scale: "2",
    rotate: 0,
    locked: false,
    flip: "1" // ç¢ºä¿æœ‰ flip å±¬æ€§

  });
  localStorage.setItem("roomData", JSON.stringify(roomData));

  loadInventory();
   

    }

    function makeFurnitureInteractive(div) {
      let offsetX, offsetY;
      div.addEventListener('touchstart', e => {
  if (e.touches.length === 1 && div.dataset.locked !== "true") {
    const touch = e.touches[0];
    const rect = div.getBoundingClientRect();
    offsetX = touch.clientX - rect.left;
    offsetY = touch.clientY - rect.top;
    div.dataset.dragging = true;
  }
      });
      div.addEventListener('touchmove', e => {
        if (div.dataset.locked === "true" || !div.dataset.dragging) return;
        const touch = e.touches[0];
        const parentRect = roomArea.getBoundingClientRect();
        div.style.left = `${touch.clientX - parentRect.left - offsetX}px`;
        div.style.top = `${touch.clientY - parentRect.top - offsetY}px`;
      });
      div.addEventListener('touchend', () => {
        div.dataset.dragging = false;
        updateRoomDataFromDOM();
      });
      div.addEventListener('click', e => {
        showFurnitureMenu(div);
      });

      div.addEventListener('mousedown', e => {
if (div.dataset.locked !== "true") {

    offsetX = e.offsetX;
    offsetY = e.offsetY;
    const onMouseMove = e2 => {
      div.style.left = `${e2.pageX - roomArea.offsetLeft - offsetX}px`;
      div.style.top = `${e2.pageY - roomArea.offsetTop - offsetY}px`;
    };
    const onMouseUp = () => {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      updateRoomDataFromDOM();
    };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
});
    }

    function updateRoomDataFromDOM() {
      const data = [...roomArea.querySelectorAll(".furniture")].map(div => ({
        name: div.dataset.name,
        x: parseInt(div.style.left),
        y: parseInt(div.style.top),
        scale: parseFloat(div.dataset.scale),
        rotate: parseInt(div.dataset.rotate),
          flip: parseInt(div.dataset.flip),   // âœ… åŠ ä¸Šé€™è¡Œï¼æ°´å¹³
        locked: div.dataset.locked === "true",
      }));
      roomData[currentRoom] = data;
      localStorage.setItem("roomData", JSON.stringify(roomData));
    }

    function loadRoomFurniture() {
      const list = roomData[currentRoom] || [];
      list.forEach(f => {
        const div = document.createElement("div");
        div.className = "furniture";
div.textContent = f.icon || inventory[f.name]?.icon || f.name;


        
        div.style.left = `${f.x}px`;
        div.style.top = `${f.y}px`;
        div.dataset.name = f.name;
        div.dataset.scale = f.scale;
        div.dataset.rotate = f.rotate;
        div.dataset.locked = f.locked;
        div.dataset.flip = f.flip || "1"; // ç¢ºä¿æœ‰ flip å±¬æ€§
        div.style.transform = `scale(${f.scale}) rotate(${f.rotate}deg)`;

        // âœ… æ­£ç¢ºå¥—ç”¨ flip / scale / rotate çµ„åˆ
    applyFurnitureTransform(div);
        makeFurnitureInteractive(div);
        roomArea.appendChild(div);
      });
    }

    function showFurnitureMenu(div) {
      selectedFurniture = div;
      menuItemName.textContent = div.dataset.name;
      const rect = div.getBoundingClientRect();
      const parentRect = roomArea.getBoundingClientRect();
      menuEl.style.left = `${rect.left - parentRect.left + rect.width + 5}px`;
      menuEl.style.top = `${rect.top - parentRect.top}px`;
      menuEl.style.display = "block";

      // ç¶ ç´…ç‹€æ…‹åˆ‡æ›
      const moveBtn = document.getElementById("moveBtn");
      const lockBtn = document.getElementById("lockBtn");
      if (div.dataset.locked === "true") {
        lockBtn.style.background = '#f55';
        lockBtn.style.color = '#fff';
        moveBtn.style.background = '#aaa';
        moveBtn.style.color = '#fff';
      } else {
        lockBtn.style.background = '#5c5';
        lockBtn.style.color = '#fff';
        moveBtn.style.background = '#5c5';
        moveBtn.style.color = '#fff';
      }

      const slider = menuEl.querySelector('input[type=range]');
      slider.value = div.dataset.scale || 2;
    }

        function setFurnitureScale(val) {
      if (!selectedFurniture || selectedFurniture.dataset.locked === "true") return;
      selectedFurniture.dataset.scale = val;
      selectedFurniture.style.transform = `scale(${val}) rotate(${selectedFurniture.dataset.rotate || 0}deg)`;
      updateRoomDataFromDOM();
    }

    function closeMenu() {
      menuEl.style.display = "none";
      selectedFurniture = null;
      moveMode = false;
    }

    function rotateFurniture() {
  if (!selectedFurniture || selectedFurniture.dataset.locked === "true") return;

  let rot = (parseInt(selectedFurniture.dataset.rotate) + 45) % 360;
  selectedFurniture.dataset.rotate = rot;

  applyFurnitureTransform(selectedFurniture); // â† ç”¨çµ±ä¸€çš„æ–¹æ³•å¥— transform
  updateRoomDataFromDOM();
    }

    //æ°´å¹³ç¿»è½‰
    function flipFurniture() {
   if (!selectedFurniture || selectedFurniture.dataset.locked === "true") return;

  const flip = selectedFurniture.dataset.flip === "-1" ? "1" : "-1";
  selectedFurniture.dataset.flip = flip;

  applyFurnitureTransform(selectedFurniture);
  updateRoomDataFromDOM();
}

function applyFurnitureTransform(furniture) {
  const scale = parseFloat(furniture.dataset.scale) || 1;
  const rotate = parseInt(furniture.dataset.rotate) || 0;
  const flip = parseInt(furniture.dataset.flip) || 1;

  // å¦‚æœç¿»è½‰ï¼Œxè»¸ç‚º -1ï¼›å¦å‰‡ç‚º 1
  const flipScaleX = flip * scale;

  // å¥—ç”¨ transformï¼šscaleXã€scaleYã€rotate
  furniture.style.transform = `scale(${flipScaleX}, ${scale}) rotate(${rotate}deg)`;
}



    function scaleFurniture(increase) {
      if (!selectedFurniture || selectedFurniture.dataset.locked === "true") return;
      let scale = parseFloat(selectedFurniture.dataset.scale);
      scale += increase ? 0.1 : -0.1;
      scale = Math.max(0.5, Math.min(2, scale));
      selectedFurniture.dataset.scale = scale;
      selectedFurniture.style.transform = `scale(${scale}) rotate(${selectedFurniture.dataset.rotate}deg)`;
      updateRoomDataFromDOM();
    }

    function toggleLockFurniture() {
      if (!selectedFurniture) return;
      selectedFurniture.dataset.locked = selectedFurniture.dataset.locked === "true" ? "false" : "true";
      updateRoomDataFromDOM();
    }

    function startMove() {
      moveMode = true;
    }

    function confirmDeleteFurniture() {
      modalEl.style.display = "flex";
    }

    function closeConfirm() {
      modalEl.style.display = "none";
    }

    function deleteFurniture() {
      if (!selectedFurniture) return;
      const name = selectedFurniture.dataset.name;
      inventory[name] = inventory[name] || { icon: selectedFurniture.textContent, quantity: 0 };
      inventory[name].quantity++;
      selectedFurniture.remove();
      localStorage.setItem("inventory", JSON.stringify(inventory));
      loadInventory();
      updateRoomDataFromDOM();
      closeMenu();
      closeConfirm();
    }

        // å¿«ç…§åŠŸèƒ½
    function takeSnapshot() {
      html2canvas(roomArea).then(canvas => {
        const link = document.createElement("a");
        link.download = "room_snapshot.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }

  // åˆ‡æ›åœ°æ¿é¡è‰²é¢æ¿
    function toggleColorPanel() {
      const panel = document.getElementById("colorPanel");
      panel.style.display = panel.style.display === "none" ? "flex" : "none";
    }

    // åœ°æ¿é¡è‰²èª¿æ•´
    const r = document.getElementById('rRange');
    const g = document.getElementById('gRange');
    const b = document.getElementById('bRange');
    const a = document.getElementById('aRange');
    [r, g, b, a].forEach(slider => {
      slider.addEventListener('input', updateFloorColor);
    });

    function updateFloorColor() {
      const rgba = `rgba(${r.value}, ${g.value}, ${b.value}, ${a.value})`;
      roomArea.style.backgroundColor = rgba;

      // å„²å­˜åˆ° localStorage
  const colorData = {
    r: r.value,
    g: g.value,
    b: b.value,
    a: a.value
  };
  localStorage.setItem('floorColor', JSON.stringify(colorData));
    }

    // é é¢è¼‰å…¥æ™‚é‚„åŸé¡è‰²
window.addEventListener('DOMContentLoaded', () => {
  const savedColor = JSON.parse(localStorage.getItem('floorColor'));
  if (savedColor) {
    r.value = savedColor.r;
    g.value = savedColor.g;
    b.value = savedColor.b;
    a.value = savedColor.a;
    updateFloorColor();
  }
});

    function createFurniture(symbol, name = "æœªçŸ¥å®¶å…·") {

          let x = 50, y = 50; // æ‰‹æ©Ÿé è¨­ä½ç½®
          console.log("å‰µå»ºå®¶å…·ï¼š", symbol, name);
       


  const div = document.createElement("div");
  div.className = "furniture";
  div.textContent = symbol;
  div.style.left = "10px";
  div.style.top = "10px";
  div.dataset.name = name;
  div.dataset.scale = "2";
  div.dataset.rotate = "0";
  div.dataset.locked = "false";
  div.dataset.flip = "1"; // æ–°å¢é€™è¡Œ
applyFurnitureTransform(div); // é è¨­æ”¾å¤§2å€
  makeFurnitureInteractive(div);
  roomArea.appendChild(div);

  // å„²å­˜é€² roomData
  roomData[currentRoom] = roomData[currentRoom] || [];
  roomData[currentRoom].push({
 name,
 
  x: x,
  y: y,
  scale: 2,
  rotate: 0,
  locked: false,
    flip: 1 // âœ… åŠ ä¸Šé€™è¡Œï¼Œæ‰æœƒè¨˜å¾—é¡åƒç‹€æ…‹

  });
  localStorage.setItem("roomData", JSON.stringify(roomData));
}





//æ‰‹æ©Ÿæ¿é»æ“Šå®¶å…·
inventoryEl.addEventListener("click", e => {
  const target = e.target.closest(".inventory-card");
  if (target) {

    console.log("é»æ“Šäº†åº«å­˜ç‰©å“ï¼š", target.dataset.name);
    const name = target.dataset.name;
    const icon = inventory[name].icon;


            if (inventory[name].quantity <= 0) {
     return;
    }


        if (inventory[name].quantity >= 1) {
                createFurniture(icon, name);
     inventory[name].quantity--;
    
 

      
    localStorage.setItem("inventory", JSON.stringify(inventory));
    loadInventory();
    }
  }
});







    updateCoins(0);
    loadStore();

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥æˆ¿é–“å®¶å…·å’Œåº«å­˜
    loadInventory();

    
    switchRoom(1);
  </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
